{% extends "base.html" %}
{% block title %}Профиль ученика{% endblock %}
{% block content %}
  <h1>Профиль: {{ student.get_full_name|default:"Без имени" }}</h1>
  <p class="muted">Цикл: {{ student.profile.get_cycle_display }}</p>
  {% if student.profile.school_grade %}
    <p class="muted">Класс: {{ student.profile.school_grade }}</p>
  {% endif %}

  <div class="card">
    <h2>Курсы</h2>
    {% if not courses %}
      <p class="muted">Нет курсов.</p>
    {% else %}
      <ul>
        {% for c in courses %}
          <li>
            <a href="/courses/{{ c.id }}/">{{ c.name }}</a>
            <span class="muted small">({{ c.course_type.name }})</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

  </div>

  <div class="card">
    <h2>Последние задания</h2>
    {% if not last_targets %}
      <p class="muted">Нет назначенных заданий.</p>
    {% else %}
      <ul>
        {% for t in last_targets %}
          <li>
            {{ t.assignment.due_date|date:"d.m.Y" }} · {{ t.assignment.course.name }} · {{ t.assignment.title }}
            <span class="muted small">({{ t.status }})</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="card">
    <h2>Последние результаты</h2>
    {% if not last_grades %}
      <p class="muted">Результатов пока нет.</p>
    {% else %}
      <ul>
        {% for g in last_grades %}
          <li>
            {{ g.assessment.course.name }} · {{ g.assessment.title }} —
            <strong>{{ g.score }}</strong>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="card">
    <h2>Прогресс</h2>
    {% if chart_has_data %}
      <div class="chart" id="grade-progress-chart"></div>
      <div class="chart" id="course-average-chart"></div>
      <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
      <script>
        const payload = {{ chart_payload|safe }};
        const darkLayout = {
          template: 'plotly_dark',
          paper_bgcolor: '#0f1115',
          plot_bgcolor: '#0f1115',
          font: { color: '#f5f5f5' },
        };
        if (payload.gradeLabels.length) {
          Plotly.newPlot('grade-progress-chart', [{
            x: payload.gradeLabels,
            y: payload.gradeScores,
            type: 'scatter',
            mode: 'lines+markers',
          }], {
            title: 'Динамика результатов',
            margin: { t: 40, r: 20, b: 120, l: 40 },
            ...darkLayout,
          }, { displayModeBar: false });
        }

        if (payload.courseAvgLabels.length) {
          Plotly.newPlot('course-average-chart', [{
            x: payload.courseAvgLabels,
            y: payload.courseAvgScores,
            type: 'bar',
          }], {
            title: 'Средний балл по курсам',
            margin: { t: 40, r: 20, b: 80, l: 40 },
            ...darkLayout,
          }, { displayModeBar: false });
        }
      </script>
    {% else %}
      <p class="muted">Нет данных для построения графиков.</p>
    {% endif %}
  </div>

  <div class="card">
    <h2>Последние отчёты уроков</h2>
    {% if not last_reports %}
      <p class="muted">Отчётов пока нет.</p>
    {% else %}
      <ul>
        {% for r in last_reports %}
          <li>
            {{ r.lesson.date|date:"d.m.Y" }} · {{ r.lesson.course.name }} · {{ r.lesson.topic }}
            {% if r.media_url %} — <a href="{{ r.media_url }}" target="_blank" rel="noopener noreferrer">медиа</a>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="card">
    <h2>Достижения</h2>
    {% if not achievements %}
      <p class="muted">Пока нет достижений.</p>
    {% else %}
      <ul>
        {% for a in achievements %}
          <li>
            {% if a.date %}{{ a.date|date:"d.m.Y" }} · {% endif %}
            {{ a.title }}
            {% if a.description %}<div class="muted small">{{ a.description }}</div>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="card">
    <h2>Медиа</h2>
    {% if not media_links %}
      <p class="muted">Пока нет ссылок.</p>
    {% else %}
      <ul>
        {% for m in media_links %}
          <li>
            <span class="tag">{{ m.get_media_type_display }}</span>
            <a href="{{ m.url }}" target="_blank" rel="noopener noreferrer">{{ m.title }}</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
{% endblock %}
