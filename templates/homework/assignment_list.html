{% extends "base.html" %}
{% block title %}Задания{% endblock %}
{% block content %}
  <h1>Задания</h1>

  {% if mode == "TEACHER" %}
    <div id="homework-delete-root" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <p class="muted" style="margin:0;">Ваши созданные задания и число назначений.</p>
      <a class="btn" href="/teacher/class/">Выбрать ученика</a>
      {% if can_bulk_delete %}
        <button class="btn" type="button" data-delete-toggle>Режим удаления</button>
      {% endif %}
    </div>

    <form method="get" class="form-row" style="margin: 12px 0;">
      <label class="muted small" for="cycle">Цикл учеников</label>
      <select id="cycle" name="cycle" class="input" onchange="this.form.submit()">
        <option value="">Все циклы</option>
        {% for value, label in cycle_options %}
          <option value="{{ value }}"{% if cycle == value %} selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <noscript><button class="btn" type="submit">Показать</button></noscript>
    </form>

    {% if not rows %}
      <p class="muted">Вы ещё не создавали задания.</p>
    {% else %}
      <form method="post" action="/assignments/bulk-delete/" onsubmit="return confirm('Удалить выбранные элементы?')">
        {% csrf_token %}
        {% if cycle %}<input type="hidden" name="cycle" value="{{ cycle }}"/>{% endif %}
        <div class="delete-mode-only" style="margin: 0 0 10px; display: none;">
          <button class="btn" type="submit">Удалить выбранное</button>
        </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th class="delete-mode-only" style="display: none;"></th>
              <th>Дедлайн</th>
              <th>Курс</th>
              <th>Задание</th>
              <th>Назначено</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td class="delete-mode-only" style="display: none;">
                  {% if r.can_delete %}
                    <input type="checkbox" name="selected_ids" value="{{ r.assignment.id }}"/>
                  {% endif %}
                </td>
                <td>{{ r.assignment.due_date|date:"d.m.Y" }}</td>
                <td class="muted small">{{ r.assignment.course.name }}</td>
                <td>
                  <div>{{ r.assignment.title }}</div>
                  {% if r.assignment.description %}
                    <div class="muted small">{{ r.assignment.description }}</div>
                  {% endif %}
                  {% if r.assignment.attachment %}
                    <div class="muted small"><a href="{{ r.assignment.attachment.url }}">Материалы</a></div>
                  {% endif %}
                </td>
                <td><span class="tag">{{ r.count_targets }}</span></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </form>
      <p class="muted small">
        Результаты выставляются в “Прогресс” → курс → “Ввод результатов”. Домашние задания появляются там автоматически.
      </p>
    {% endif %}

  {% elif mode == "STUDENT" %}
    <p class="muted">Показаны только задания, назначенные вам.</p>
    <p class="muted small">Цикл: {{ student.profile.get_cycle_display }}</p>

    {% if not rows %}
      <p class="muted">Назначенных заданий пока нет.</p>
    {% else %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Дедлайн</th>
              <th>Курс</th>
              <th>Задание</th>
              <th>Статус</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>{{ r.assignment.due_date|date:"d.m.Y" }}</td>
                <td class="muted small">{{ r.assignment.course.name }}</td>
                <td>
                  <div>{{ r.assignment.title }}</div>
                  {% if r.assignment.description %}
                    <div class="muted small">{{ r.assignment.description }}</div>
                  {% endif %}
                  {% if r.assignment.attachment %}
                    <div class="muted small"><a href="{{ r.assignment.attachment.url }}">Материалы</a></div>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-{{ r.status|lower }}">{{ r.status }}</span>
                </td>
                <td>
                  {% if r.target.status != "DONE" %}
                    <form method="post" action="/assignments/targets/{{ r.target.id }}/mark_done/">
                      {% csrf_token %}
                      <button class="btn" type="submit">DONE</button>
                    </form>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

  {% elif mode == "PARENT" %}
    <p class="muted">По каждому ребёнку показаны назначенные задания и статус.</p>

    {% if not child_blocks %}
      <p class="muted">Нет привязанных детей.</p>
    {% else %}
      {% for block in child_blocks %}
        <h2>Ученик: {{ block.child.username }}</h2>
        <p class="muted small">Цикл: {{ block.child.profile.get_cycle_display }}</p>
        {% if not block.rows %}
          <p class="muted">Назначенных заданий нет.</p>
        {% else %}
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Дедлайн</th>
                  <th>Курс</th>
                  <th>Задание</th>
                  <th>Статус</th>
                </tr>
              </thead>
              <tbody>
                {% for r in block.rows %}
                  <tr>
                    <td>{{ r.assignment.due_date|date:"d.m.Y" }}</td>
                    <td class="muted small">{{ r.assignment.course.name }}</td>
                    <td>
                      <div>{{ r.assignment.title }}</div>
                      {% if r.assignment.description %}
                        <div class="muted small">{{ r.assignment.description }}</div>
                      {% endif %}
                      {% if r.assignment.attachment %}
                        <div class="muted small"><a href="{{ r.assignment.attachment.url }}">Материалы</a></div>
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge badge-{{ r.status|lower }}">{{ r.status }}</span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

  {% elif mode == "ADMIN" %}
    <div id="homework-delete-root" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <p class="muted" style="margin:0;">Все задания (админ-обзор).</p>
      {% if can_bulk_delete %}
        <button class="btn" type="button" data-delete-toggle>Режим удаления</button>
      {% endif %}
    </div>
    <form method="get" class="form-row" style="margin: 12px 0;">
      <label class="muted small" for="cycle">Цикл учеников</label>
      <select id="cycle" name="cycle" class="input" onchange="this.form.submit()">
        <option value="">Все циклы</option>
        {% for value, label in cycle_options %}
          <option value="{{ value }}"{% if cycle == value %} selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <noscript><button class="btn" type="submit">Показать</button></noscript>
    </form>
    {% if not assignments %}
      <p class="muted">Заданий пока нет.</p>
    {% else %}
      <form method="post" action="/assignments/bulk-delete/" onsubmit="return confirm('Удалить выбранные элементы?')">
        {% csrf_token %}
        {% if cycle %}<input type="hidden" name="cycle" value="{{ cycle }}"/>{% endif %}
        <div class="delete-mode-only" style="margin: 0 0 10px; display: none;">
          <button class="btn" type="submit">Удалить выбранное</button>
        </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th class="delete-mode-only" style="display: none;"></th>
              <th>Дедлайн</th>
              <th>Курс</th>
              <th>Задание</th>
              <th class="muted small">Создал</th>
            </tr>
          </thead>
          <tbody>
            {% for row in assignments %}
              <tr>
                <td class="delete-mode-only" style="display: none;">
                  {% if row.can_delete %}
                    <input type="checkbox" name="selected_ids" value="{{ row.assignment.id }}"/>
                  {% endif %}
                </td>
                <td>{{ row.assignment.due_date|date:"d.m.Y" }}</td>
                <td class="muted small">{{ row.assignment.course.name }}</td>
                <td>
                  <div>{{ row.assignment.title }}</div>
                  {% if row.assignment.attachment %}
                    <div class="muted small"><a href="{{ row.assignment.attachment.url }}">Материалы</a></div>
                  {% endif %}
                </td>
                <td class="muted small">{{ row.assignment.created_by.username }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </form>
    {% endif %}

  {% else %}
    <p class="muted">Недоступно.</p>
  {% endif %}

  <script>
    (function () {
      const root = document.getElementById("homework-delete-root");
      if (!root) return;
      const toggle = root.querySelector("[data-delete-toggle]");
      if (!toggle) return;
      const controls = document.querySelectorAll(".delete-mode-only");
      toggle.addEventListener("click", function () {
        root.classList.toggle("delete-mode");
        const visible = root.classList.contains("delete-mode");
        toggle.textContent = visible ? "Скрыть удаление" : "Режим удаления";
        controls.forEach(function (el) {
          if (el.tagName === "TH" || el.tagName === "TD") {
            el.style.display = visible ? "table-cell" : "none";
          } else {
            el.style.display = visible ? "block" : "none";
          }
        });
      });
    })();
  </script>
{% endblock %}
