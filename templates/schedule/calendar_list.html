{% extends "base.html" %}
{% block title %}Календарь{% endblock %}
{% block content %}
  <section class="page-head">
    <h1>Расписание</h1>
    <p>Просматривайте и управляйте недельным расписанием.</p>
  </section>

  <section class="week-toolbar">
    <h2 style="font-size:24px;margin:0;">Неделя: {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a class="btn btn-small" href="?week={{ week_offset|add:'-1' }}">Предыдущая</a>
      <a class="btn btn-small" href="/calendar/">Текущая</a>
      <a class="btn btn-small" href="?week={{ week_offset|add:'1' }}">Следующая</a>
    </div>
  </section>

  <section class="week-grid">
    {% for day in week_columns %}
      <article class="week-column {% if day.is_today %}is-today{% endif %}">
        <h3>{{ day.weekday_label }}</h3>
        <small>{{ day.date_label }}</small>

        {% if day.events %}
          {% for event in day.events %}
            <div class="event-card">
              <span class="time">{{ event.time_label }}</span>
              <strong>{{ event.title }}</strong>
              <span class="small muted">{{ event.subtitle }}</span>
              {% if event.description %}<span class="small muted">{{ event.description }}</span>{% endif %}
              <span class="small muted">{{ event.type_label }}</span>

              {% if event.external_url %}
                <a class="btn btn-small" href="{{ event.external_url }}" target="_blank" rel="noopener noreferrer">Ссылка</a>
              {% endif %}

              {% if mode == "student" and event.can_register %}
                <form method="post" action="/calendar/register/{{ event.id }}/">
                  {% csrf_token %}
                  <button class="btn btn-small btn-accent" type="submit">Записаться</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p class="small muted" style="margin-top:10px;">Уроки не запланированы.</p>
        {% endif %}
      </article>
    {% endfor %}
  </section>

  {% if mode == "student" and available_registration %}
    <section class="panel" style="margin-top: 12px;">
      <h2 style="font-size:22px;">Доступно для регистрации</h2>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Событие</th>
              <th>Курс</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for event in available_registration %}
              <tr>
                <td>{{ event.start_datetime|date:"d.m.Y H:i" }}</td>
                <td>{{ event.title }}</td>
                <td>{% if event.course %}{{ event.course.name }}{% else %}—{% endif %}</td>
                <td>
                  <form method="post" action="/calendar/register/{{ event.id }}/">
                    {% csrf_token %}
                    <button class="btn btn-small btn-accent" type="submit">Записаться</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock %}
