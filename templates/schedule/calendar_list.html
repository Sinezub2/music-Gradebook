{% extends "base.html" %}
{% block title %}Календарь{% endblock %}
{% block content %}
  <section class="page-head">
    <h1>Расписание</h1>
    <p>Просматривайте недельные слоты занятий.</p>
  </section>

  <section class="week-toolbar">
    <h2 style="font-size:24px;margin:0;">Неделя: {{ week_start|date:"d.m.Y" }} - {{ week_end|date:"d.m.Y" }}</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a class="btn btn-small" href="?week={{ week_offset|add:'-1' }}">Предыдущая</a>
      <a class="btn btn-small" href="/calendar/">Текущая</a>
      <a class="btn btn-small" href="?week={{ week_offset|add:'1' }}">Следующая</a>
    </div>
  </section>

  <section class="week-grid">
    {% for day in week_columns %}
      <article class="week-column {% if day.is_today %}is-today{% endif %}">
        <h3>{{ day.weekday_label }}</h3>
        <small>{{ day.date_label }}</small>

        {% if day.slots %}
          {% for slot in day.slots %}
            <div class="event-card">
              <span class="time">{{ slot.time_label }}</span>
              <strong>{{ slot.title }}</strong>
              <span class="small muted">{{ slot.subtitle }}</span>
              <span class="small muted">{{ slot.status_label }}</span>
              {% if slot.attendance_label %}
                <span class="small muted">{{ slot.attendance_label }}</span>
              {% endif %}

              {% if mode == "teacher" and slot.can_fill_report %}
                <a class="btn btn-small btn-accent" href="{{ slot.report_url }}">
                  {% if slot.status == "PLANNED" %}Заполнить отчёт{% else %}Открыть отчёт{% endif %}
                </a>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {% if day.events %}
          {% for event in day.events %}
            <div class="event-card">
              <span class="time">{{ event.time_label }}</span>
              <strong>{{ event.title }}</strong>
              <span class="small muted">{{ event.subtitle }}</span>
              {% if event.description %}<span class="small muted">{{ event.description }}</span>{% endif %}
              <span class="small muted">{{ event.type_label }}</span>

              {% if event.external_url %}
                <a class="btn btn-small" href="{{ event.external_url }}" target="_blank" rel="noopener noreferrer">Ссылка</a>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {% if not day.slots and not day.events %}
          <p class="small muted" style="margin-top:10px;">Уроки не запланированы.</p>
        {% endif %}
      </article>
    {% endfor %}
  </section>
{% endblock %}
