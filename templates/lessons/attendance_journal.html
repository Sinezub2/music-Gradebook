{% extends "base.html" %}
{% block title %}Журнал посещаемости{% endblock %}
{% block content %}
  <h1>Журнал посещаемости</h1>

  <div class="card">
    <form method="get" class="form">
      <div class="form-row">
        <label for="cycle">Цикл учеников</label>
        <select id="cycle" name="cycle">
          <option value="">Все циклы</option>
          {% for value, label in cycle_options %}
            <option value="{{ value }}"{% if cycle == value %} selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label for="month">Месяц</label>
        <input id="month" type="month" name="month" value="{{ month_value }}">
      </div>
      <button class="btn" type="submit">Показать</button>
    </form>
  </div>

  <div class="card">
    {% if not students %}
      <p class="muted">Нет учеников для выбранного цикла.</p>
    {% elif not rows %}
      <p class="muted">Нет учебных дней за выбранный месяц.</p>
    {% else %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Дата</th>
              {% for student in students %}
                <th>{{ student.get_full_name|default:student.username }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
              <tr>
                <td>{{ row.date|date:"d.m.Y" }}</td>
                {% for cell in row.cells %}
                  <td class="attendance-cell">
                    {% if user.profile.role == "TEACHER" or user.profile.role == "ADMIN" %}
                      <form method="post" class="form-row" style="gap: 6px;">
                        {% csrf_token %}
                        <input type="hidden" name="student_id" value="{{ cell.student.id }}">
                        <input type="hidden" name="date" value="{{ row.date|date:'Y-m-d' }}">
                        {% if cycle %}
                          <input type="hidden" name="cycle" value="{{ cycle }}">
                        {% endif %}
                        {% if month_value %}
                          <input type="hidden" name="month" value="{{ month_value }}">
                        {% endif %}
                        <label class="muted small">
                          <input type="checkbox" name="attended" {% if cell.attended %}checked{% endif %}>
                          отметка
                        </label>
                        <button class="btn btn-small" type="submit">Сохранить</button>
                      </form>
                    {% else %}
                      {% if cell.attended %}
                        <span class="attendance-yes">✓</span>
                      {% elif cell.attended == False %}
                        <span class="attendance-no">—</span>
                      {% else %}
                        <span class="attendance-empty">—</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <th>Итого (месяц)</th>
              {% for total in totals %}
                <th class="attendance-cell">{{ total.label }}</th>
              {% endfor %}
            </tr>
          </tfoot>
        </table>
      </div>
      <p class="muted small">Общее рабочее время за месяц: {{ overall_total_label }}.</p>
    {% endif %}
  </div>
{% endblock %}
