{% extends "base.html" %}
{% block title %}Отчёт по занятию{% endblock %}
{% block content %}
  <section class="page-head">
    <h1>Отчёт по занятию</h1>
    <p>
      {{ student.get_full_name|default:"Без имени" }} · {{ course.name }} ·
      {{ slot.scheduled_date|date:"d.m.Y" }} {{ slot.start_time|time:"H:i" }}
    </p>
  </section>

  <section class="panel">
    <form method="post" class="form" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-row">
        <label>{{ form.attendance_status.label }}</label>
        {{ form.attendance_status }}
        {% if form.attendance_status.errors %}<div class="error">{{ form.attendance_status.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label>{{ form.result_note.label }}</label>
        {{ form.result_note }}
        {% if form.result_note.errors %}<div class="error">{{ form.result_note.errors }}</div>{% endif %}
      </div>

      <h2 style="margin: 0;">Композиции</h2>
      <div id="slot-play-list">
        {% for play in initial_plays %}
          <div class="card lesson-play-row" style="margin-bottom: 10px;" data-play-row>
            <div class="form-row">
              <label>Название</label>
              <input class="input" type="text" name="play_name" value="{{ play.name }}" placeholder="Название композиции">
            </div>
            <div class="form-row">
              <label class="muted small">
                <input type="checkbox" name="play_completed" value="{{ forloop.counter0 }}"{% if play.completed %} checked{% endif %}>
                Выполнено
              </label>
            </div>
            <div class="form-row">
              <label>Комментарий</label>
              <input class="input" type="text" name="play_comment" value="{{ play.comment }}" placeholder="Комментарий (опционально)">
            </div>
          </div>
        {% endfor %}
      </div>
      <button class="btn" type="button" id="slot-play-add">+</button>
      {% if play_errors %}
        {% for error in play_errors %}
          <div class="error">{{ error }}</div>
        {% endfor %}
      {% endif %}

      <div class="form-row">
        <label>{{ form.report_comment.label }}</label>
        {{ form.report_comment }}
        {% if form.report_comment.errors %}<div class="error">{{ form.report_comment.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label>{{ form.media_url.label }}</label>
        {{ form.media_url }}
        {% if form.media_url.errors %}<div class="error">{{ form.media_url.errors }}</div>{% endif %}
      </div>

      <div class="form-row">
        <label>{{ form.attachment.label }}</label>
        {{ form.attachment }}
        {% if form.attachment.errors %}<div class="error">{{ form.attachment.errors }}</div>{% endif %}
      </div>

      <button class="btn btn-accent" type="submit">Сохранить отчёт</button>
      <a class="btn" href="/calendar/">Назад к расписанию</a>
    </form>
  </section>

  <script>
    (function () {
      const list = document.getElementById("slot-play-list");
      const addButton = document.getElementById("slot-play-add");
      if (!list || !addButton) return;

      function resequence() {
        list.querySelectorAll("[data-play-row]").forEach(function (row, index) {
          const checkbox = row.querySelector('input[name="play_completed"]');
          if (checkbox) checkbox.value = String(index);
        });
      }

      addButton.addEventListener("click", function () {
        const row = document.createElement("div");
        row.className = "card lesson-play-row";
        row.style.marginBottom = "10px";
        row.setAttribute("data-play-row", "1");
        row.innerHTML = [
          '<div class="form-row"><label>Название</label><input class="input" type="text" name="play_name" placeholder="Название композиции"></div>',
          '<div class="form-row"><label class="muted small"><input type="checkbox" name="play_completed" value="0"> Выполнено</label></div>',
          '<div class="form-row"><label>Комментарий</label><input class="input" type="text" name="play_comment" placeholder="Комментарий (опционально)"></div>'
        ].join("");
        list.appendChild(row);
        resequence();
      });

      resequence();
    })();
  </script>
{% endblock %}
